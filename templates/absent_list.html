<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liste des absents</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- html2canvas and jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


<style>
body { font-family: 'Inter', Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; color: #333; }
.container { max-width: 1200px; margin: 30px auto; padding: 20px; }
h1 { text-align: center; color: #5a0e8c; font-weight: 700; font-size: 28px; margin-bottom: 25px; }

.dropdowns-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
select { appearance: none; -webkit-appearance: none; -moz-appearance: none; padding: 12px 16px; font-size: 15px; font-weight: 500; border: 2px solid #5a0e8c; border-radius: 12px; background: #fff url("data:image/svg+xml;utf8,<svg fill='%235a0e8c' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat right 12px center; background-size: 18px; color: #333; cursor: pointer; transition: all 0.3s ease; min-width: 220px; }
select:hover { border-color: #450a6a; box-shadow: 0 4px 10px rgba(90,14,140,0.2); }
select:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 8px rgba(212,175,55,0.4); }

.table-responsive { overflow-x: auto; margin-top: 20px; }
table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
th, td { padding: 14px 18px; text-align: left; font-size: 15px; }
th { background: #f0f0f0; font-weight: 600; color: #555; }
tbody tr:hover { background: #f8f4ff; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }

/* Buttons */
.btn { border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease; margin-right: 10px; }
.btn-primary { background: #5a0e8c; color: #fff; }
.btn-primary:hover { background: #450a6a; }
.btn-success { background: #4caf50; color: #fff; }
.btn-success:hover { background: #388e3c; }

#noData { text-align: center; color: #e53935; font-weight: bold; margin-top: 20px; }
</style>
</head>
<body>
<div class="container">
  <h1>Liste des absents par dimanche</h1>

  <div class="dropdowns-container">
    <select id="month">
      <option value="">-- Choisir un mois --</option>
      {% for year, month, month_name in months %}
      <option value="{{ year }}-{{ month }}"
        {% if year == current_year and month == current_month %}selected{% endif %}>
        {{ month_name }} {{ year }}
      </option>
      {% endfor %}
    </select>

    <select id="sunday">
      <option value="">-- Choisir un dimanche --</option>
    </select>
  </div>

  <div style="text-align:center; margin-bottom:15px;">
    <button class="btn btn-success" id="downloadPdf">Télécharger PDF</button>
    <button class="btn btn-primary" id="screenshotBtn">Prendre screenshot</button>
  </div>

  <div class="table-responsive" id="tableContainer" style="display:none;">
    <table id="absentTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>N° Téléphone</th>
          <th>Lieu d'habitation</th>
        </tr>
      </thead>
      <tbody id="absentBody"></tbody>
    </table>
  </div>
  <div id="noData" style="display:none;">Aucun absent pour ce dimanche</div>
</div>

<script>
const monthDropdown = document.getElementById("month");
const sundayDropdown = document.getElementById("sunday");
const tableContainer = document.getElementById("tableContainer");
const absentBody = document.getElementById("absentBody");
const noData = document.getElementById("noData");

// Populate Sundays
monthDropdown.addEventListener("change", () => {
  const [year, month] = (monthDropdown.value || "").split("-");
  sundayDropdown.innerHTML = "<option value=''>-- Choisir un dimanche --</option>";
  tableContainer.style.display = "none";
  noData.style.display = "none";

  if (year && month) {
    const y = parseInt(year), m = parseInt(month);
    const daysInMonth = new Date(y, m, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      const dateObj = new Date(y, m - 1, d);
      if (dateObj.getDay() === 0) { // Sunday
        const option = document.createElement("option");
        option.value = dateObj.toISOString().split("T")[0];
        option.textContent = dateObj.toLocaleDateString("fr-FR", { weekday:'long', day:'numeric', month:'long', year:'numeric' });
        sundayDropdown.appendChild(option);
      }
    }
  }
});

// Load absent data
sundayDropdown.addEventListener("change", async () => {
  const val = sundayDropdown.value;
  absentBody.innerHTML = "";
  tableContainer.style.display = "none";
  noData.style.display = "none";
  if (!val) return;

  try {
    const res = await fetch("/get-absents?sunday=" + encodeURIComponent(val));
    if (!res.ok) throw new Error("Erreur réseau");
    const data = await res.json();
    if (!data || !data.length) {
      noData.style.display = "block";
      return;
    }

    data.forEach(m => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${m.last_name}</td><td>${m.first_name}</td><td>${m.phone}</td><td>${m.place}</td>`;
      absentBody.appendChild(row);
    });

    tableContainer.style.display = "block";
  } catch (err) {
    console.error(err);
    alert("Erreur lors du chargement des absents");
  }
});

// PDF download with header
document.getElementById("downloadPdf").onclick = () => {
  if(!sundayDropdown.value) { alert("Veuillez sélectionner un dimanche."); return; }

  // Create a temporary container with header
  const pdfContainer = document.createElement("div");
  pdfContainer.innerHTML = `<h2 style="text-align:center; margin-bottom:20px;">
    Liste des absents - ${new Date(sundayDropdown.value).toLocaleDateString("fr-FR", { weekday:'long', day:'numeric', month:'long', year:'numeric' })}
  </h2>`;
  pdfContainer.appendChild(tableContainer.cloneNode(true));

  const opt = { margin:0.5, filename:'absents.pdf', image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  html2pdf().set(opt).from(pdfContainer).save();
};

// Screenshot
document.getElementById("screenshotBtn").onclick = () => {
  if (!sundayDropdown.value || !absentBody.children.length) return alert("Aucun absent à capturer.");

  const tempDiv = document.createElement("div");
  tempDiv.style.background = "#fff";
  tempDiv.style.padding = "20px";
  tempDiv.style.width = tableContainer.offsetWidth + "px";
  tempDiv.style.boxSizing = "border-box";

  const header = document.createElement("h2");
  header.style.textAlign = "center";
  header.style.marginBottom = "20px";
  header.textContent = "Liste des absents - " + new Date(sundayDropdown.value)
      .toLocaleDateString("fr-FR", { weekday:'long', day:'numeric', month:'long', year:'numeric' });
  tempDiv.appendChild(header);

  const clone = tableContainer.cloneNode(true);
  clone.style.width = "100%";
  tempDiv.appendChild(clone);

  tempDiv.style.position = "absolute";
  tempDiv.style.top = "-9999px";
  document.body.appendChild(tempDiv);

  html2canvas(tempDiv, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = 'absents.png';
    link.href = canvas.toDataURL("image/png");
    link.click();
    document.body.removeChild(tempDiv);
  }).catch(err => {
    console.error("Screenshot failed:", err);
    alert("Erreur lors de la capture de l'écran.");
  });
};

// Trigger month change on load if selected
if (monthDropdown.value) monthDropdown.dispatchEvent(new Event("change"));
</script>
</body>
</html>
